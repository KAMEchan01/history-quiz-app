// ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
class HistoryQuizApp {
    constructor() {
        this.currentTheme = 'ocean';
        this.settings = this.loadSettings();
        this.stats = this.loadStats();
        this.init();
    }

    init() {
        this.applyTheme(this.settings.theme);
        this.updateStats();
        this.setupEventListeners();
    }

    // è¨­å®šã®èª­ã¿è¾¼ã¿
    loadSettings() {
        const defaultSettings = {
            theme: 'ocean',
            soundEnabled: true,
            bgmVolume: 0.3,
            effectVolume: 0.7
        };
        
        const saved = localStorage.getItem('historyQuizSettings');
        return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
    }

    // çµ±è¨ˆã®èª­ã¿è¾¼ã¿
    loadStats() {
        const defaultStats = {
            totalQuestionsAnswered: 0,
            correctAnswers: 0,
            overallAccuracy: 0,
            studyStreak: 0,
            totalStudyTimeMinutes: 0
        };
        
        const saved = localStorage.getItem('historyQuizStats');
        return saved ? { ...defaultStats, ...JSON.parse(saved) } : defaultStats;
    }

    // è¨­å®šã®ä¿å­˜
    saveSettings() {
        localStorage.setItem('historyQuizSettings', JSON.stringify(this.settings));
    }

    // çµ±è¨ˆã®ä¿å­˜
    saveStats() {
        localStorage.setItem('historyQuizStats', JSON.stringify(this.stats));
    }

    // ãƒ†ãƒ¼ãƒã®é©ç”¨
    applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        this.currentTheme = theme;
        this.settings.theme = theme;
        this.saveSettings();
    }

    // çµ±è¨ˆã®æ›´æ–°
    updateStats() {
        const elements = {
            totalQuestions: document.getElementById('totalQuestions'),
            correctRate: document.getElementById('correctRate'),
            studyStreak: document.getElementById('studyStreak')
        };

        if (elements.totalQuestions) {
            elements.totalQuestions.textContent = this.stats.totalQuestionsAnswered || '-';
        }
        if (elements.correctRate) {
            const rate = this.stats.totalQuestionsAnswered > 0 
                ? Math.round((this.stats.correctAnswers / this.stats.totalQuestionsAnswered) * 100)
                : 0;
            elements.correctRate.textContent = rate > 0 ? `${rate}%` : '-';
        }
        if (elements.studyStreak) {
            elements.studyStreak.textContent = this.stats.studyStreak || '-';
        }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    setupEventListeners() {
        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
        const themeOptions = document.querySelectorAll('.theme-option');
        themeOptions.forEach(option => {
            option.addEventListener('click', () => {
                themeOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                const theme = option.dataset.theme;
                this.applyTheme(theme);
            });
        });

        // éŸ³éŸ¿è¨­å®š
        const soundToggle = document.getElementById('soundEnabled');
        if (soundToggle) {
            soundToggle.checked = this.settings.soundEnabled;
            soundToggle.addEventListener('change', (e) => {
                this.settings.soundEnabled = e.target.checked;
                this.saveSettings();
            });
        }

        const bgmVolume = document.getElementById('bgmVolume');
        if (bgmVolume) {
            bgmVolume.value = this.settings.bgmVolume * 100;
            bgmVolume.addEventListener('input', (e) => {
                this.settings.bgmVolume = e.target.value / 100;
                this.saveSettings();
                this.updateBGMVolume();
            });
        }

        const effectVolume = document.getElementById('effectVolume');
        if (effectVolume) {
            effectVolume.value = this.settings.effectVolume * 100;
            effectVolume.addEventListener('input', (e) => {
                this.settings.effectVolume = e.target.value / 100;
                this.saveSettings();
            });
        }
    }

    // BGMéŸ³é‡ã®æ›´æ–°
    updateBGMVolume() {
        const bgmSound = document.getElementById('bgmSound');
        if (bgmSound) {
            bgmSound.volume = this.settings.bgmVolume;
        }
    }

    // åŠ¹æœéŸ³å†ç”Ÿ
    playSound(soundType, condition = null) {
        if (!this.settings.soundEnabled) return;

        const audio = document.getElementById(`${soundType}Sound`);
        if (audio) {
            audio.volume = this.settings.effectVolume;
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Sound play failed:', e));
        }
    }

    // BGMå†ç”Ÿ/åœæ­¢
    toggleBGM(play = true) {
        const bgmSound = document.getElementById('bgmSound');
        if (bgmSound && this.settings.soundEnabled) {
            bgmSound.volume = this.settings.bgmVolume;
            if (play) {
                bgmSound.play().catch(e => console.log('BGM play failed:', e));
            } else {
                bgmSound.pause();
            }
        }
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
let app;

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    app = new HistoryQuizApp();
    loadSavedPhoto();
});

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
function startQuiz() {
    window.location.href = 'pages/era-selection.html';
}

function goHome() {
    window.location.href = '../index.html';
}

function goToEraSelection() {
    window.location.href = 'era-selection.html';
}

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
function openSettings() {
    const modal = document.getElementById('settingsModal');
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function closeSettings() {
    const modal = document.getElementById('settingsModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.addEventListener('click', (e) => {
    const modal = document.getElementById('settingsModal');
    if (modal && e.target === modal) {
        closeSettings();
    }
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #E74C3C;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1001;
        max-width: 300px;
    `;
    errorDiv.textContent = message;
    
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }, 5000);
}

// æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27AE60;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1001;
        max-width: 300px;
    `;
    successDiv.textContent = message;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.parentNode.removeChild(successDiv);
        }
    }, 3000);
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.remove('hidden');
    }
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}åˆ†${remainingSeconds.toString().padStart(2, '0')}ç§’`;
}

// æ²–ç¸„å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
function selectPhoto() {
    const photoInput = document.getElementById('photoInput');
    if (photoInput) {
        photoInput.click();
    }
}

function loadSavedPhoto() {
    const photoInput = document.getElementById('photoInput');
    const okinawaPhoto = document.getElementById('okinawaPhoto');
    const photoContainer = document.querySelector('.okinawa-photo-container');
    
    if (!photoInput || !okinawaPhoto || !photoContainer) return;
    
    // ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’èª­ã¿è¾¼ã¿
    const savedPhoto = localStorage.getItem('okinawaPhoto');
    if (savedPhoto) {
        displayPhoto(savedPhoto);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    photoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const photoData = e.target.result;
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('okinawaPhoto', photoData);
                displayPhoto(photoData);
                showSuccess('æ²–ç¸„ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ğŸŒŠ');
            };
            reader.readAsDataURL(file);
        } else {
            showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        }
    });
}

function displayPhoto(photoData) {
    const okinawaPhoto = document.getElementById('okinawaPhoto');
    const photoContainer = document.querySelector('.okinawa-photo-container');
    const removeButton = document.getElementById('removeButton');
    
    if (okinawaPhoto && photoContainer) {
        okinawaPhoto.src = photoData;
        okinawaPhoto.onload = () => {
            okinawaPhoto.classList.add('loaded');
            photoContainer.classList.add('has-photo');
            if (removeButton) {
                removeButton.style.display = 'inline-block';
            }
        };
    }
}

function removePhoto() {
    if (confirm('æ²–ç¸„ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem('okinawaPhoto');
        const okinawaPhoto = document.getElementById('okinawaPhoto');
        const photoContainer = document.querySelector('.okinawa-photo-container');
        const removeButton = document.getElementById('removeButton');
        
        if (okinawaPhoto && photoContainer) {
            okinawaPhoto.src = '';
            okinawaPhoto.classList.remove('loaded');
            photoContainer.classList.remove('has-photo');
            if (removeButton) {
                removeButton.style.display = 'none';
            }
        }
        showSuccess('å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
}

// ãƒ‡ãƒãƒƒã‚°ç”¨
function resetProgress() {
    if (confirm('å­¦ç¿’é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        localStorage.removeItem('historyQuizStats');
        localStorage.removeItem('historyQuizProgress');
        location.reload();
    }
}

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ï¼‰
window.HistoryQuizApp = HistoryQuizApp;